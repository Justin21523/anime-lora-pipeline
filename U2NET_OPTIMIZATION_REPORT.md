# U2Net åƒæ•¸å„ªåŒ–æ¸¬è©¦å ±å‘Š

**æ¸¬è©¦æ—¥æœŸ**: 2025-10-30
**æ¸¬è©¦åœ–ç‰‡**: 10 å¼µ Yokai Watch frames
**æ¸¬è©¦é…ç½®**: 8 ç¨®åƒæ•¸çµ„åˆ
**æ¸¬è©¦ç’°å¢ƒ**: CUDA (GPU)

---

## ğŸ“Š æ¸¬è©¦çµæœç¸½çµ

### æ•´é«”æ€§èƒ½æ’å

| æ’å | é…ç½® | å¹³å‡è¦†è“‹ç‡ | å¹³å‡é‚Šç•Œæ¡† | å¹³å‡æ™‚é–“ | æ¨è–¦åº¦ |
|------|------|------------|------------|----------|--------|
| ğŸ¥‡ 1 | **æ¿€é€²ç‰ˆæœ¬** | **22.9%** | **38.9%** | 0.031s | â­â­â­â­â­ |
| ğŸ¥ˆ 2 | **æ“´å¼µç‰ˆæœ¬** | **21.5%** | 36.8% | 0.030s | â­â­â­â­ |
| ğŸ¥‰ 3 | å¹³æ»‘å„ªå…ˆ | 20.5% | 36.1% | 0.033s | â­â­â­ |
| 4 | å¼·åŒ–é‚Šç·£ | 20.5% | 36.8% | 0.030s | â­â­â­ |
| 5 | **åŸºç¤ç‰ˆæœ¬** (ç•¶å‰) | 20.5% | 36.8% | 0.067s | â­â­â­ |
| 6 | Alpha Matting | 20.5% | 36.8% | 0.028s | â­â­â­ |
| 7 | ä¿å®ˆç‰ˆæœ¬ | 20.3% | 35.5% | 0.039s | â­â­ |
| 8 | ç²¾ç´°æ¨¡å¼ | 20.3% | 36.2% | 0.033s | â­â­ |

---

## ğŸ¯ é—œéµç™¼ç¾

### 1. æœ€ä½³é…ç½®: æ¿€é€²ç‰ˆæœ¬ â­â­â­â­â­

**æå‡æ•ˆæœ**:
- âœ… è¦†è“‹ç‡æå‡: **20.5% â†’ 22.9%** (+2.4%)
- âœ… é‚Šç•Œæ¡†æå‡: **36.8% â†’ 38.9%** (+2.1%)
- âœ… é€Ÿåº¦æå‡: **0.067s â†’ 0.031s** (2x faster)

**é…ç½®åƒæ•¸**:
```python
{
    "morphology": True,
    "kernel_size": 3,          # å°æ ¸å¿ƒ - ä¿ç•™ç´°ç¯€
    "close": True,
    "close_iter": 5,           # å¼·åŠ›å¡«å…… - é€£æ¥æ–·è£‚éƒ¨åˆ†
    "open": False,             # ä¸åš open - ä¿ç•™æ‰€æœ‰å€åŸŸ
    "blur": True,
    "blur_size": 3,            # å°æ¨¡ç³Š - å¹³æ»‘ä½†ä¸éåº¦
    "threshold": 100,          # ä½é–¾å€¼ - åŒ…å«æ›´å¤šå€åŸŸ
    "dilate": True,
    "dilate_size": 7,          # å¤§æ“´å¼µ - ç²å¾—å®Œæ•´è¼ªå»“
    "dilate_iter": 3           # å¤šæ¬¡æ“´å¼µ
}
```

**é©ç”¨å ´æ™¯**:
- âœ… éœ€è¦ç²å¾—**å®Œæ•´è§’è‰²è¼ªå»“**
- âœ… å…è¨±åŒ…å«**éƒ¨åˆ†å‘¨é‚Šå€åŸŸ**
- âœ… å„ªå…ˆ**å®Œæ•´æ€§**è€Œéç²¾ç¢ºåº¦

---

### 2. æ¬¡å„ªé…ç½®: æ“´å¼µç‰ˆæœ¬ â­â­â­â­

**æå‡æ•ˆæœ**:
- âœ… è¦†è“‹ç‡æå‡: **20.5% â†’ 21.5%** (+1.0%)
- âœ… é€Ÿåº¦æå‡: **0.067s â†’ 0.030s** (2x faster)

**é…ç½®åƒæ•¸**:
```python
{
    "morphology": True,
    "kernel_size": 5,          # ä¸­ç­‰æ ¸å¿ƒ
    "close": True,
    "close_iter": 2,           # ä¸­ç­‰å¡«å……
    "open": True,
    "open_iter": 1,            # è¼•åº¦æ¸…ç†
    "blur": True,
    "blur_size": 5,            # ä¸­ç­‰æ¨¡ç³Š
    "threshold": 127,          # æ¨™æº–é–¾å€¼
    "dilate": True,
    "dilate_size": 5,          # ä¸­ç­‰æ“´å¼µ
    "dilate_iter": 2           # å…©æ¬¡æ“´å¼µ
}
```

**é©ç”¨å ´æ™¯**:
- âœ… å¹³è¡¡**å®Œæ•´æ€§èˆ‡ç²¾ç¢ºåº¦**
- âœ… é©åˆå¤§å¤šæ•¸è§’è‰²é¡å‹
- âœ… ç©©å®šå¯é çš„é¸æ“‡

---

### 3. åŸºç¤ç‰ˆæœ¬çš„å•é¡Œ

**å•é¡Œç™¼ç¾**:
- âš ï¸ é€Ÿåº¦æ…¢: 0.067s (å…¶ä»–é…ç½® ~0.030s)
- âš ï¸ è¦†è“‹ç‡ä¸­ç­‰: 20.5%
- âš ï¸ æ²’æœ‰é‡å°æ€§å„ªåŒ–

**çµè«–**: å¯ä»¥è¢«ã€Œæ¿€é€²ç‰ˆæœ¬ã€æˆ–ã€Œæ“´å¼µç‰ˆæœ¬ã€å®Œå…¨å–ä»£

---

## ğŸ“ˆ é€é…ç½®è©³ç´°åˆ†æ

### æ¿€é€²ç‰ˆæœ¬ (æ¨è–¦)

**å„ªå‹¢**:
1. âœ… **æœ€é«˜è¦†è“‹ç‡** 22.9%
2. âœ… **æœ€å¤§é‚Šç•Œæ¡†** 38.9%
3. âœ… **é€Ÿåº¦å¿«** 0.031s
4. âœ… åœ¨å›°é›£æ¡ˆä¾‹ä¸­è¡¨ç¾å„ªç•°

**å…¸å‹æ¡ˆä¾‹**:
```
scene0065: 43.7% (vs åŸºç¤ 40.0%)  â†’ +3.7%
scene0377: 42.2% (vs åŸºç¤ 38.3%)  â†’ +3.9%
scene0258: 0.8% (vs åŸºç¤ 0.1%)    â†’ +0.7% (æ¥µå›°é›£æ¡ˆä¾‹)
```

**é™åˆ¶**:
- âš ï¸ å¯èƒ½åŒ…å«**å°‘é‡èƒŒæ™¯**åœ¨è§’è‰²å‘¨åœ
- âš ï¸ å°æ–¼**ç²¾ç´°é‚Šç·£**è¦æ±‚é«˜çš„å ´æ™¯å¯èƒ½éåº¦

**å»ºè­°ä½¿ç”¨æƒ…å¢ƒ**:
- âœ… LoRA è¨“ç·´ (éœ€è¦å®Œæ•´è§’è‰²)
- âœ… è§’è‰²èšé¡ (CLIP éœ€è¦è¶³å¤ ä¸Šä¸‹æ–‡)
- âœ… å¤§è¦æ¨¡è™•ç† (é€Ÿåº¦å¿«)

---

### æ“´å¼µç‰ˆæœ¬ (ç©©å¥é¸æ“‡)

**å„ªå‹¢**:
1. âœ… **æ¬¡é«˜è¦†è“‹ç‡** 21.5%
2. âœ… **ç©©å®šæ€§å¥½** - å„åœ–ç‰‡è¡¨ç¾å¹³è¡¡
3. âœ… **é€Ÿåº¦å¿«** 0.030s

**é©åˆäººç¾¤**:
- âœ… å¸Œæœ›**è¼ƒå®Œæ•´ä½†ä¸éæ¿€**çš„åˆ†å‰²
- âœ… å°é‚Šç·£è³ªé‡æœ‰ä¸€å®šè¦æ±‚
- âœ… éœ€è¦ç©©å®šå¯é æ¸¬çš„çµæœ

---

### å…¶ä»–é…ç½®åˆ†æ

**Alpha Matting**:
- èˆ‡åŸºç¤ç‰ˆæœ¬å¹¾ä¹ç›¸åŒ
- ç„¡æ˜é¡¯æå‡
- ä¸æ¨è–¦

**å¹³æ»‘å„ªå…ˆ**:
- è¦†è“‹ç‡èˆ‡åŸºç¤ç›¸åŒ
- é‚Šç·£æ›´å¹³æ»‘
- é©åˆéœ€è¦å¹³æ»‘è¼ªå»“çš„å ´æ™¯

**ä¿å®ˆç‰ˆæœ¬ & ç²¾ç´°æ¨¡å¼**:
- è¦†è“‹ç‡æœ€ä½ 20.3%
- æ›´ç²¾ç¢ºä½†å¯èƒ½éºæ¼éƒ¨åˆ†
- é©åˆç²¾ç´°åº¦å„ªå…ˆçš„å ´æ™¯

---

## ğŸ”¬ å€‹åˆ¥åœ–ç‰‡å°æ¯”

### é«˜è³ªé‡æ¡ˆä¾‹

**scene0065 (å¤šè§’è‰²å ´æ™¯)**:
| é…ç½® | è¦†è“‹ç‡ | æå‡ |
|------|--------|------|
| åŸºç¤ç‰ˆæœ¬ | 40.0% | - |
| æ“´å¼µç‰ˆæœ¬ | 41.6% | +1.6% |
| **æ¿€é€²ç‰ˆæœ¬** | **43.7%** | **+3.7%** â­ |

**scene0377 (é›™è§’è‰²)**:
| é…ç½® | è¦†è“‹ç‡ | æå‡ |
|------|--------|------|
| åŸºç¤ç‰ˆæœ¬ | 38.3% | - |
| æ“´å¼µç‰ˆæœ¬ | 39.9% | +1.6% |
| **æ¿€é€²ç‰ˆæœ¬** | **42.2%** | **+3.9%** â­ |

### å›°é›£æ¡ˆä¾‹

**scene0471 (å°è§’è‰²)**:
| é…ç½® | è¦†è“‹ç‡ | æå‡ |
|------|--------|------|
| åŸºç¤ç‰ˆæœ¬ | 4.6% | - |
| æ“´å¼µç‰ˆæœ¬ | 5.4% | +0.8% |
| **æ¿€é€²ç‰ˆæœ¬** | **6.4%** | **+1.8%** â­ |

**scene0258 (æ¥µå›°é›£)**:
| é…ç½® | è¦†è“‹ç‡ | æå‡ |
|------|--------|------|
| åŸºç¤ç‰ˆæœ¬ | 0.1% | - |
| ä¿å®ˆç‰ˆæœ¬ | 0.0% | -0.1% âŒ |
| **æ¿€é€²ç‰ˆæœ¬** | **0.8%** | **+0.7%** â­ |

---

## ğŸ’¡ å¯¦æ–½å»ºè­°

### æ¨è–¦æ–¹æ¡ˆ: æ¡ç”¨ã€Œæ¿€é€²ç‰ˆæœ¬ã€

#### Step 1: æ›´æ–°åˆ†å‰²è…³æœ¬

ä¿®æ”¹ `layered_segmentation_parallel.py` çš„ `refine_mask` å‡½æ•¸:

```python
def refine_mask(mask: np.ndarray) -> np.ndarray:
    """å„ªåŒ–ç‰ˆ mask ç²¾ç…‰ - æ¿€é€²ç‰ˆæœ¬"""
    # Close operation - å¼·åŠ›å¡«å……å°æ´å’Œé€£æ¥æ–·è£‚
    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
    mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel, iterations=5)

    # è·³é Open operation - ä¿ç•™æ‰€æœ‰å€åŸŸ

    # å°ç¯„åœæ¨¡ç³Š - å¹³æ»‘ä½†ä¿ç•™ç´°ç¯€
    mask = cv2.GaussianBlur(mask, (3, 3), 0)

    # ä½é–¾å€¼ - åŒ…å«æ›´å¤šå€åŸŸ
    _, mask = cv2.threshold(mask, 100, 255, cv2.THRESH_BINARY)

    # å¤§ç¯„åœæ“´å¼µ - ç²å¾—å®Œæ•´è¼ªå»“
    dilate_kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (7, 7))
    mask = cv2.dilate(mask, dilate_kernel, iterations=3)

    return mask
```

#### Step 2: æ¸¬è©¦å„ªåŒ–ç‰ˆæœ¬

åœ¨å°è¦æ¨¡æ•¸æ“šä¸Šæ¸¬è©¦:

```bash
conda run -n blip2-env python3 \
  scripts/tools/layered_segmentation_parallel.py \
  /home/b0979/yokai_input_fast/S1.01 \
  --output-dir /tmp/yokai_test_optimized \
  --num-workers 16 \
  --seg-model u2net \
  --inpaint-method telea
```

#### Step 3: è¦–è¦ºæª¢æŸ¥

æŸ¥çœ‹å„ªåŒ–çµæœ:
```bash
# ç•¶å‰æ¸¬è©¦çµæœä½ç½®
/mnt/c/AI_LLM_projects/ai_warehouse/outputs/u2net_optimization/image_*/æ¿€é€²ç‰ˆæœ¬/
```

æ¯å€‹åœ–ç‰‡æœ‰ä¸‰å€‹æ–‡ä»¶:
- `mask.png` - åˆ†å‰² mask
- `character.png` - æå–çš„è§’è‰² (RGBA)
- `overlay.jpg` - åŸåœ– + mask ç–ŠåŠ  (ç¶ è‰²)

#### Step 4: å¦‚æœæ»¿æ„ï¼Œå…¨é¢éƒ¨ç½²

ä½¿ç”¨å„ªåŒ–ç‰ˆæœ¬è™•ç†æ‰€æœ‰ frames:

```bash
# ä¿®æ”¹å¾Œé‡æ–°é‹è¡Œå®Œæ•´ pipeline
./scripts/batch/test_yokai_parallel.sh  # å…ˆæ¸¬è©¦
./scripts/batch/run_yokai_parallel_full.sh  # å®Œæ•´é‹è¡Œ
```

---

## ğŸ“Š æ€§èƒ½å°æ¯”

### è™•ç†é€Ÿåº¦

| é…ç½® | å–®å¼µæ™‚é–“ | 1M frames é ä¼° |
|------|----------|----------------|
| åŸºç¤ç‰ˆæœ¬ (ç•¶å‰) | 0.067s | 19 å°æ™‚ |
| **æ¿€é€²ç‰ˆæœ¬** | 0.031s | **9 å°æ™‚** â­ |
| æ“´å¼µç‰ˆæœ¬ | 0.030s | **8.5 å°æ™‚** â­ |

**16 ä¸¦è¡Œ workers**:
- æ¿€é€²ç‰ˆæœ¬: **~34 åˆ†é˜** for 1M frames

---

## ğŸ¯ æœ€çµ‚å»ºè­°

### é¸æ“‡å»ºè­°

**å„ªå…ˆæ¨è–¦: æ¿€é€²ç‰ˆæœ¬**

**ç†ç”±**:
1. âœ… **æœ€å®Œæ•´çš„è§’è‰²æå–** (+2.4% è¦†è“‹ç‡)
2. âœ… **2å€é€Ÿåº¦æå‡** (0.067s â†’ 0.031s)
3. âœ… **å›°é›£æ¡ˆä¾‹è¡¨ç¾å„ªç•°**
4. âœ… **é©åˆ LoRA è¨“ç·´éœ€æ±‚**

**å¦‚æœè¿½æ±‚ç©©å¥**: æ“´å¼µç‰ˆæœ¬
- è¼ƒä¿å®ˆçš„æå‡
- æ›´å¹³è¡¡çš„è¡¨ç¾
- é©åˆå¤šæ•¸å ´æ™¯

**å¦‚æœè¿½æ±‚ç²¾ç´°**: ç²¾ç´°æ¨¡å¼
- æœ€ç²¾ç¢ºçš„é‚Šç·£
- ä½†å¯èƒ½éºæ¼éƒ¨åˆ†å€åŸŸ
- é©åˆé«˜è³ªé‡å–®åœ–è™•ç†

---

## ğŸ“ æ¸¬è©¦æ•¸æ“šä½ç½®

- **å®Œæ•´å ±å‘Š JSON**: `/mnt/c/AI_LLM_projects/ai_warehouse/outputs/u2net_optimization/optimization_report.json`
- **è¦–è¦ºçµæœ**: `/mnt/c/AI_LLM_projects/ai_warehouse/outputs/u2net_optimization/image_*/`
  - æ¯å€‹åœ–ç‰‡ç›®éŒ„åŒ…å« 8 ç¨®é…ç½®çš„çµæœ
  - æ¯ç¨®é…ç½®æœ‰ maskã€characterã€overlay ä¸‰å€‹æ–‡ä»¶
- **å°æ¯”æŸ¥çœ‹**: å¯ä»¥ç›´æ¥ç”¨åœ–ç‰‡æŸ¥çœ‹å™¨å°æ¯”åŒä¸€åœ–ç‰‡çš„ä¸åŒé…ç½®

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. âœ… **æŸ¥çœ‹è¦–è¦ºçµæœ** - ç¢ºèªã€Œæ¿€é€²ç‰ˆæœ¬ã€ç¬¦åˆä½ çš„éœ€æ±‚
2. âœ… **æ›´æ–°åˆ†å‰²è…³æœ¬** - æ¡ç”¨æ¨è–¦çš„åƒæ•¸é…ç½®
3. âœ… **å°è¦æ¨¡æ¸¬è©¦** - åœ¨ 1-2 episodes ä¸Šé©—è­‰
4. âœ… **å…¨é¢éƒ¨ç½²** - ä½¿ç”¨å„ªåŒ–ç‰ˆæœ¬è™•ç†æ‰€æœ‰ Yokai Watch frames

**é æœŸæ”¹å–„**:
- âœ… è§’è‰²å®Œæ•´åº¦æå‡ **~10-15%**
- âœ… è™•ç†é€Ÿåº¦æå‡ **2å€**
- âœ… æ›´å¥½çš„ LoRA è¨“ç·´è³ªé‡

---

ä½ æƒ³è¦æˆ‘ç«‹å³æ›´æ–°åˆ†å‰²è…³æœ¬ä½¿ç”¨ã€Œæ¿€é€²ç‰ˆæœ¬ã€é…ç½®å—ï¼Ÿæˆ–è€…ä½ æƒ³å…ˆæŸ¥çœ‹å…¶ä»–é…ç½®çš„è¦–è¦ºçµæœï¼Ÿ
